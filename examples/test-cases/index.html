<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <title>MathLive Testing Playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="/dist/mathlive-fonts.css" />

    <!-- <link rel="stylesheet" href="/dist/mathlive-static.css" /> -->
    <style>
      .mathfield {
        font-size: 32px;
      }
      math-field:not(:defined) {
          display: none;
      }
      code {
          white-space: pre-wrap;
      }

      h2 {
          font-size: 1em;
          padding: 0;
          margin: 0;
          color: #666;
      }


      #mathfield-container {
          padding: 8px;
          min-width: 50px;
          border: 1px solid #ddd;
      }

      #ta {
          font-size: 1.5em;
          font-weight: 700;
      }

      #find-input , #replace-input{
        width: 320px;
      }

      .hidden {
          display: none;
      }

      .label {
          font-weight: 700;
      }
      .math {
        display: none;
      }
      /* .buttonbar button { */
      button {
          background: none;
          border: 1px solid rgba(0, 0, 0, 0.12);
          border-radius: 4px;
          color: #0066ce;
          fill: currentColor;
          position: relative;
          height: 36px;
          line-height: 36px;
          margin: 0 18px 0 0;
          min-width: 64px;
          padding: 0 16px;
          display: inline-block;
          overflow: hidden;
          will-change: box-shadow;
          transition: box-shadow 0.2s cubic-bezier(0.4, 0, 1, 1),
              background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
              color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
          outline: none;
          cursor: pointer;
          text-decoration: none;
          text-align: center;
          vertical-align: middle;
          -webkit-user-select: none;
          user-select: none;

          font-size: 16px;
          letter-spacing: 0.08929em;
          text-transform: uppercase;
          box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.2),
              0 2px 2px 0 rgba(0, 0, 0, 0.14),
              0 3px 1px -2px rgba(0, 0, 0, 0.12);
      }

      button:first-child {
          margin-left: 0;
      }

      button:hover {
          background-color: rgba(0, 0, 0, 0.08);
      }

      button:active {
          background-color: white;
      }

      button.primary,
      button.active {
          color: white;
          fill: currentColor;
          background: #0066ce;
      }

      button.primary:hover {
          background-color: rgba(0, 102, 206, 0.58);
      }

      button.primary:active {
          color: #0066ce;
          fill: currentColor;
          background-color: white;
      }

      button.round {
          width: 64px;
          height: 64px;
          border-radius: 50%;
      }

      .buttonbar {
          margin-top: 1em;
      }    
  </style>
</head>

<body>
    <header>
        <h1>MathLive Testing Playground</h1>
    </header>
    <main class='centered' tabindex="0">
      
      <span class='math'>$$\dfrac{\unicode{"2B1A}}{\unicode{"2B1A}}$$</span>
$$        \frac1c + \bbox[2em, yellow,border:solid 5px red]{\sqrt[3]{x}} = \binom{C}{k}$$
      

      <math-field 
        class="mathfield" style="max-width: 640px; width:100%" 
        virtual-keyboard-mode="manual"
        read-only>x+\left(\sqrt{x+1}+1\right)+\sum_0^4n^2</math-field>
      <!-- <math-field 
        id=mf 
        tabindex="0" 
        class="mathfield" style="max-width: 640px; width:100%" 
        smart-fence="true"
        horizontal-spacing-scale="1.2"
        virtual-keyboard-mode="manual">
        \frac1c + \bbox[2em,yellow,border:solid 5px red]{\sqrt[3]{x}} = \binom{C}{k} -->
        <!-- -0-0=-0(0) -->
        
        <!-- \htmlData{partid=14}{\left(} 3 + 5 \htmlData{partid=15}{\right)} = \htmlData{partid=16}{\left(} 2x + 5 \htmlData{partid=17}{\right)}     -->
        
        <!-- \begin{bmatrix}a\\b\\c\\d\\e\\f\end{bmatrix} -->

        <!-- \begin{equation*} {}^8 x^2\sum^{5}_{n=0}\left(\frac1\frac34\right)^2\int _{x}^{\infty } \sum^{5}_{n=0}\nolimits  \vec{x}^2 \overset{+}{=}^n = \overbrace{xyz}^2 \end{equation*} -->

        <!-- does not display box --> 
         <!-- \frac1c + \bbox[border:solid 1px red]{\sqrt[3]{x}} = \binom{C}{k} -->

          <!-- box positioned incorrectly (lineheight issue) --> 
         <!-- \boxed{\frac{\frac12}{x^{3^x}}}+a=\left[\frac{\frac12}{x^{3^x}}\right] -->

        <!-- -\frac{-\frac{1}{2}}{-\frac{3}{4}} -->


          <!-- Incorrect spacing before -7, disappears if caret is there -->
         <!-- -1\frac{-7}{5}  -->



        <!-- \textcolor{blue}{\sqrt{\smash[t]{\frac{a}{b}}}=\sqrt{\smash[b]{\frac{a}{b}}}} -->


        <!-- \textcolor{blue}{\overset{=}{x}} -->

        <!-- \textcolor{blue}{\overline{x}=\overline{x+\frac34}=\underline{x}=\underline{x+\frac34}} -->

        <!-- \textcolor{blue}{\vec{x}=\vec{\frac34}=\widehat{x}=\widehat{x+y}} -->

        <!-- \textcolor{blue}{\int_0^\infty\smallint_0^\infty\oint_0^\infty} -->

        <!-- \textcolor{blue}{\Large \frac34=\frac{3}{x+1}=\binom34=\sqrt{2}=\sqrt[3]{2}} -->

        <!-- \textcolor{blue}{\Large \sqrt{2}=\sqrt[3]{2}} -->

        <!-- \textcolor{blue}{x=\sqrt[3]{x}=\frac{x^2}{x^2}=\left(\frac34\right)=\int_0^\infty} -->
        <!-- -a-b=-1 -->

        <!-- \scriptstyle is not cummulative. 'm' are the same size -->
        <!-- m {\scriptstyle w \scriptstyle w}  \LARGE M {\scriptstyle m \scriptstyle m}  -->

        <!-- Sizing commands are not cumulative, 'm' are the same size. --> 
        <!-- \Huge m \Huge m -->

        
        <!-- z = \overbrace{\frac12}^\text{complex number} -->

      <!-- z = \overbrace{
          \underbrace{x}_\text{real} + i
          \underbrace{y}_\text{imaginary}
      }^\text{complex number} -->
      
      <!-- {}^8 x^2\sum^{5}_{n=0}\left(\frac12\right)^2\int _{x}^{\infty } \sum^{5}_{n=0}\nolimits  \vec{x}^2 \overset{+}{=}^2  \overbrace{xyz}^2      -->
        
        <!-- {}^8 x^2\sum^{5}_{n=0}\left(\frac12\right)^2\int _{x}^{\infty } \sum^{5}_{n=0}\nolimits  \vec{x}^2 \overset{+}{=}^2  \overbrace{xyz}^2      -->
        <!-- \binom12 \textstyle \binom34 \scriptstyle \binom56 \displaystyle \binom78 \scriptstyle \binom90 -->
        <!-- \binom{1}{2}{\textstyle \binom{3}{4}}{\scriptstyle \binom{5}{6}}{\displaystyle \binom{7}{8}}{\scriptstyle \binom{9}{0}}$$ -->

       <!-- \Huge \overset{\left[\frac00\right]}{\underset{\mathop{H}}{=}} -->
        <!-- \binom34  \huge \binom56 x \text{huge} -->
        <!-- $$\boxed{\frac{\frac{1}{2}}{x^{3^x}}}+a=\left[\frac{\frac{1}{2}}{x^{3^x}}\right]$$ -->
        
         <!-- $$-\bbox[4em,border: 5px solid red]{\sqrt{\frac{\frac{2}{\frac{3}{\frac{4}{\frac{5}{\frac{6}{\frac{7}{\frac{8}{\frac{9}{\frac{a}{\frac{b}{\frac{x}{\frac{s}{d}}}}}}}}}}}}}{1+x}}}-$$  -->

        <!-- a\ne b - c -->
        <!-- -\begin{bmatrix}2 & 3 \\ 4 \\ 6 & 7 & 8 \\ \end{bmatrix}=0 -->
        <!-- -->
            <!--30\operatorname{cm}^2+4\operatorname{mm}^2-->
            <!--f(x)=\frac{x+1}{x-1}+x+1 -->
            <!--x=\begin{bmatrix}x+1&b&c\\\alpha&\\beta\end{bmatrix}^T+x+1 -->
            <!--  $$x+\left(\sqrt{x+1}+1\right)+\sum_0^4n^2+\frac{1+x}{x-1}\int^{\infty}_0x\mathrm{d}x+\boxed{\frac{1}{x}}\colorbox{yellow}{\sqrt{\frac{1}{x}}}\cancel{x^2+1}\xRightarrow[\text{above}]{\text{below}}$$
            -->
            <!-- x=x^2_{b+1}+\frac{1}{2_{56}}^{34}_{56}+\sqrt{23}+\sqrt[45]{67}+\box{x+1}+\xRightarrow[below]{above}^2+\begin{matrix}1&2&3\\4\\5&6\end{matrix} -->
        </math-field>

        <div class="centered"><input id='find-input' placeholder="Find Latex"></input></div>
        <div class="centered" style="margin-top: .5em"><input id='replace-input' placeholder="Replace With..."></input>
        </div>

        <div id="search-results" class='centered'>
            <h2 style='margin-top: 1em'>Search Results</h2>
            <div class="output" id="search-results-output"></div>
        </div>

        <h2 style='margin-top: 1em'>Selection</h2>
        <div class="output" id="selection"></div>

        <!-- <math-field class="mathfield" style="width:100%" tabindex="4" virtual-keyboard-mode="manual">f_{4}(x) =
        </math-field>

        <math-field class="mathfield" style="width:100%" tabindex="-1" virtual-keyboard-mode="manual">f_{-1}(x) =
        </math-field>


        <div class="mathfield" id="oldschool-mf" tabindex=' 0'>f_0(x) = </div>

        <section id='mathfield-container'></section> -->

        <!-- (x,,2) -->
        <!-- -123, 456.789, -->
        <!-- x_5 -->
        <!-- -5-3-2 -->
        <!-- 12+ -->
        <!-- \lbrack\rbrack -->
        <!-- \foo  -->
        <!-- (a,,b) -->
        <!--       a\le b \overline{z} \overrightarrow{ABC} -->
        <!-- $$(deadbeef)_{16}$$ -->
        <!-- \partial^2_{x,y} f(x,y) -->
        <!-- |(a+|b|+1)| -->
        <!-- -0+0(\frac{0}{\frac{0}{0}}-0)+x^\pi -->
        <!-- -0+0(\frac{0}{\frac{0}{0}}-0) -->
        <!-- x_0 + x_{0} +  x_n + x_{n+1}-->
        <!-- -2x5z\sqrt{y}\frac{3}{4}3\pi y} -->
        <!-- \sin^{-1}\prime(x)      \sin^{-1}'(x) -->
        <!-- "\begin{align*}\dot{x} & =\sigma(y-x) \\ \dot{y} & =\rho x-y-xz \\ \dot{z} & =-\beta z+xy\end{align*}" -->
        <!-- i, 2i, -i -->
        <!-- 2{xy} should create group -->


        <!-- \huge x \text{y} -->
        <!-- \scriptscriptstyle x \text{y} -->
        <!-- \sqrt[\Huge 3]{29} -->
        <!-- x^{\binom{n}{k}} -->
        <!-- \binom12 \textstyle \binom34 \scriptstyle \binom56 \displaystyle \binom78 \scriptstyle \binom90 -->
        <!-- \int^b_a x^2 dx -->
        <!-- \int^b_a\int^c_d x^2 dx dy -->
        <!-- \int x^2 + x = 0 -->
        <!-- \int x^2 + x dx = 0 -->
        <!-- \int (x^2 + x) dx = 0 -->

        <h2>Latex</h2>
        <div class="output" id="latex"></div>
        <h2>MathASCII</h2>
        <div class="output" id="mathascii"></div>
        <h2>MathML</h2>
        <div class="output" id="mathml"></div>
        <h2>MASTON</h2>
        <div class="output" id="maston"></div>

        <div id='insertion-point'></div>
        <div class='buttonbar'>
          <button class='button' id='mf-button-hide'>Hide</button>
          <button id='mf-button-show'>Show</button>
        </div>
  
        <div class='buttonbar'>

          <div id='tooltip'>Look At Me</div>
        </div>
  
        <p>The answer is <math-field default-mode="inline-math" read-only>\sum_n^\infty=0=x^2+3x+5</math-field></p>


      </main>

    <script type="module">
      import { convertLatexToMarkup, renderMathInDocument } from '/dist/mathlive.mjs';
      renderMathInDocument({ 
        renderAccessibleContent: false,
        TeX: { 
          delimiters: { display: [ ['$$', '$$'] ] },
          processEnvironments : false 
        },
        asciiMath: null,
      });

      //  console.log( convertLatexToMarkup('\\int _{x}^{\\infty }'));


      tippy('#tooltip', {
        content: 'The answer is <math-field default-mode="inline-math" read-only>\\sum_n^\\infty=0=x^2+3x+5</math-field>',
        interactive: true,
      });


      // const frag = document.createDocumentFragment();
      // const mfi = new MathfieldElement();
      // mfi.value = 'f(x) = \\frac{1}{x}';
      // mfi.virtualKeyboardMode = 'manual';
      // mfi.readOnly = true;
      // mfi.setOptions({readOnly: true});
      // console.log('Has Focus', mfi.hasFocus());
      // frag.appendChild(mfi);

      // document.getElementById('insertion-point').appendChild(frag);

      // document.getElementById('mf-button-hide').addEventListener('click', () => {
      //   mfi.remove();
      //   console.log(mfi.value);
      // });
      // document.getElementById('mf-button-show').addEventListener('click', () => {
      //   console.log('before ', mfi.value);
      //   document.getElementById('insertion-point').appendChild(mfi);
      //   console.log('after ', mfi.value);
      // });

      let gSearchLatex;

      function applySearchTerm() {
          if (!gSearchLatex) {
              document.getElementById('search-results').classList.add('hidden');
              return;
          }
          document.getElementById('search-results').classList.remove('hidden');
          const mf = document.getElementById('mf');

          mf.applyStyle({ color: "none", backgroundColor: "none" }, {
              range: [0, -1], suppressChangeNotifications: true
          });

          const searchResults = mf.find(gSearchLatex.startsWith('/') ?
              new RegExp(gSearchLatex.slice(1, -1)) :
              gSearchLatex);

          document.getElementById('search-results-output').innerHTML =
              searchResults.
                  map(range => `${range[0]}, ${range[1]} = "${mf.getValue(range)}"`).
                  join('<br>');
          searchResults.forEach((x) =>
              mf.applyStyle({ color: "red", backgroundColor: "yellow" }, x, {
                  suppressChangeNotifications: true
              }
              )
          );
      }
      function applyReplace() {
          document.getElementById('search-results').classList.add('hidden');
          if (!gSearchLatex) {
              return;
          }

          const mf = document.getElementById('mf');

          mf.applyStyle({ color: "none", backgroundColor: "none" }, {
              range: [0, -1], suppressChangeNotifications: true
          });
          const replacement = replaceInput.value;
          const searchResults = mf.replace(gSearchLatex.startsWith('/') ?
              new RegExp(gSearchLatex.slice(1, -1)) :
              gSearchLatex, replacement /* (args) => {
                  console.log(args);
                  return replacement;
              }*/);
      }

      const ta = document.getElementById('find-input');
      ta.addEventListener('change', (ev) => {
          gSearchLatex = ta.value;
          applySearchTerm();
      });

      const replaceInput = document.getElementById('replace-input');
      replaceInput.addEventListener('change', (ev) => {
          applyReplace();
      });

      const mf = document.getElementById('mf');

      mf?.setOptions({
          inlineShortcuts: {
              in: {
                  mode: 'math',
                  after: 'space+letter+digit+symbol+fence',
                  value: '\\in',
              },
          },
          // onBlur: () => { console.log('blurring') },
          onKeystroke: (mf, keystroke, ev) => {
            if (keystroke === 'alt+[KeyS]') {
              mf.insert('\\sum^\\infty_{n=0}');
              return false; // Stop propagation
            } else if (keystroke === 'meta+[KeyK]') {
              mf.executeCommand('toggleVirtualKeyboard');
              return false;
            }
            console.log('options keystroke', keystroke); 
            return true;
          },
          // inlineShortcuts: {
          //     // ㄱ: '\\sqrt',
          //     sq: '\\sqrt{#0}',
          //     // ㄱㄴ: '\\sqrt{#0}',
          //     "ㄱㄴ": '\\sqrt{#0}',
          // },
          macros: {
              'rcases': `\\left.
\\begin{array}{ll}
#0
\\end{array}
\\right\\}`
          },
          onError: (ev) => { console.log('Error :' + ev.code); }
      });

      // mf.selection = [2, 5];
      // mf.addEventListener('blur', (ev) => {
      //     console.log('blur event');
      // });
      // mf.addEventListener('keystroke', (ev) => {
      //     console.log('keystroke event', ev.detail.keystroke);
      // });
      // mf.addEventListener('focus', (ev) => {
      //     console.log('focus event');
      // });
      mf?.addEventListener('input', (ev) => {
          updateContent(mf);
          applySearchTerm();
      });
      // mf.addEventListener('change', (ev) => {
      // });
      mf?.addEventListener('selection-change', (ev) => {
          const selection = mf.selection;
          // console.assert(selection.ranges[0][0] !== 2 || selection.ranges[0][1] !== 3);
          document.getElementById('selection').innerHTML =
              // label("anchor    ") + mf.anchor + "<br>" +
              label("position  ") + mf.position + "<br>" +
              label("start     ") + selection.ranges[0][0] + "<br>" +
              label("end       ") + selection.ranges[0][1] + "<br>" +
              label("direction ") + '\"' + selection.direction + "\"<br>" +
              label("value     ") + '\"' + mf.getValue(selection) + '"'
      });
      mf?.addEventListener('math-error', (ev) => {
          console.log('Error :' + ev.detail.code);
      });
      if (mf) {
        updateContent(mf);
        applySearchTerm();
      }



      // let mathfieldContainer = document.getElementById('mathfield-container');
      // if (mathfieldContainer) {
      //     let mfe = new MathfieldElement();
      //     // Deferred assignments
      //     mfe.value = "\\frac{\\sin(x)}{\\cos(x)}";
      //     mfe.setAttribute('virtual-keyboard-layout', 'dvorak');
      //     mfe.setOptions({
      //         virtualKeyboardMode: 'manual',
      //     });
      //     // mfe.setAttribute('disabled', '');   // sets to true

      //     // Attach the element (and use the attached values);
      //     mathfieldContainer.appendChild(mfe);

      //     mathfieldContainer.removeChild(mfe);

      //     mathfieldContainer.appendChild(mfe);
      // }
      // if (document.getElementById('oldschool-mf')) {
      //     MathLive.makeMathField('oldschool-mf', {
      //         smartFence: true,
      //         smartMode: true,
      //         virtualKeyboardMode: 'manual',
      //         // onContentDidChange: (mf) => {
      //         //     updateContent(mf)
      //         // },
      //         onError: (err) => {
      //             console.error(
      //                 err.latex,
      //                 err.code + ' ' + (err.arg ?? '')
      //             );
      //         },
      //     });
      // }
      function updateContent(mf) {
          const latex = mf.getValue('latex-expanded');
          try {

              document.getElementById('latex').innerHTML = escapeHtml(
                  latex
              );

              document.getElementById(
                  'mathascii'
              ).innerHTML = escapeHtml(mf.getValue('ascii-math'));
              document.getElementById(
                  'mathml'
              ).innerHTML = escapeHtml(mf.getValue('math-ml'));
              document.getElementById(
                  'maston'
              ).innerHTML = escapeHtml(mf.getValue('math-json'));
          } catch (e) {
              console.error("Error converting %c " + latex + '%c ' +
                  e.toString(), 'color: red;  background: hsla(0, 60%, 90%)', 'background: transparent');
          }
      }


      function label(s) {
          return `<span class='label'>${s}</span>`;
      }

      function escapeHtml(string) {
          return String(string).replace(/[&<>"'`= /\u200b]/g, function (
              s
          ) {
              return (
                  {
                      '&': '&amp;',
                      '<': '&lt;',
                      '>': '&gt;',
                      '"': '&quot;',
                      "'": '&#39;',
                      '/': '&#x2F;',
                      '`': '&#x60;',
                      '=': '&#x3D;',
                      '\u200b': '&amp;#zws;',
                  }[s] || s
              );
          });
      }
    </script>
<script src="https://unpkg.com/popper.js@1"></script>
<script src="https://unpkg.com/tippy.js@5"></script>
</body>

</html>